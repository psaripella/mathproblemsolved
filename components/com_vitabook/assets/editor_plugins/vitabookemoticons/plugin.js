tinymce.PluginManager.add("vitabookemoticons",function(e,t){function r(){var e;e='<table role="presentation" class="mce-grid">';tinymce.each(n,function(n){e+="<tr>";tinymce.each(n,function(n){var r=t+"/img/"+n+".gif";e+='<td><a href="#" data-mce-url="'+r+'" tabindex="-1"><img src="'+r+'" style="width: 18px; height: 18px"></a></td>'});e+="</tr>"});e+="</table>";return e}function i(){var e=navigator.userAgent.toLowerCase();return e.indexOf("msie")!=-1?parseInt(e.split("msie")[1]):false}function s(e,t){u(e,-1,"",t)}function o(e,t){u(e,0,"",t)}function u(e,t,n,r){var i,s,o,u,f,l,c,h,p;r=r+"/img/";i=e.selection.getRng().cloneRange();if(i.startOffset<2){h=i.endContainer.previousSibling;if(h==null){if(i.endContainer.firstChild==null||i.endContainer.firstChild.nextSibling==null)return;h=i.endContainer.firstChild.nextSibling}p=h.length;i.setStart(h,p);i.setEnd(h,p);if(i.endOffset<2)return;s=i.endOffset;u=h}else{u=i.endContainer;if(u.nodeType!=3&&u.firstChild){while(u.nodeType!=3&&u.firstChild)u=u.firstChild;i.setStart(u,0);i.setEnd(u,u.nodeValue.length)}if(i.endOffset==1)s=2;else s=i.endOffset-1-t}o=s;do{i.setStart(u,s-2);i.setEnd(u,s-1);s-=1}while(i.toString()!=" "&&i.toString()!=""&&i.toString().charCodeAt(0)!=160&&s-2>=0&&i.toString()!=n);if(i.toString()==n||i.toString().charCodeAt(0)==160){i.setStart(u,s);i.setEnd(u,o);s+=1}else if(i.startOffset==0){i.setStart(u,0);i.setEnd(u,o)}else{i.setStart(u,s);i.setEnd(u,o)}l=i.toString();c=l.match(/^(:-?\)|:-?\(|:-?P|;-?\)|:-?D|:-?8|:zzz|:-?@|:roll|:eek|:sigh|:-?\?|;-?\(|:-?x)$/i);if(c){var d=/:-?\)/i;var v=/:-?\(/i;var m=/:-?P/i;var g=/;-?\)/i;var y=/:-?D/i;var b=/:-?8/;var w=/:zzz/;var E=/:-?@/;var S=/:roll/;var x=/:eek/;var T=/:sigh/;var N=/:-?\?/;var C=/;-?\(/;var k=/:-?x/;if(d.test(c[1])){var L=r+"sm_smile.gif";a(L,i)}else if(v.test(c[1])){var L=r+"sm_mad.gif";a(L,i)}else if(m.test(c[1])){var L=r+"sm_razz.gif";a(L,i)}else if(g.test(c[1])){var L=r+"sm_wink.gif";a(L,i)}else if(y.test(c[1])){var L=r+"sm_biggrin.gif";a(L,i)}else if(b.test(c[1])){var L=r+"sm_cool.gif";a(L,i)}else if(w.test(c[1])){var L=r+"sm_sleep.gif";a(L,i)}else if(E.test(c[1])){var L=r+"sm_upset.gif";a(L,i)}else if(S.test(c[1])){var L=r+"sm_rolleyes.gif";a(L,i)}else if(x.test(c[1])){var L=r+"sm_bigeek.gif";a(L,i)}else if(T.test(c[1])){var L=r+"sm_sigh.gif";a(L,i)}else if(N.test(c[1])){var L=r+"sm_confused.gif";a(L,i)}else if(C.test(c[1])){var L=r+"sm_cry.gif";a(L,i)}else if(k.test(c[1])){var L=r+"sm_dead.gif";a(L,i)}}}function a(t,n){bookmark=e.selection.getBookmark();e.selection.setRng(n);e.execCommand("mceInsertContent",false,'<img src="'+t+'" alt="" border="0" class="smiley" />');e.selection.moveToBookmark(bookmark);e.nodeChanged()}var n=[["sm_bigeek","sm_biggrin","sm_confused","sm_cool"],["sm_cry","sm_dead","sm_mad","sm_razz"],["sm_rolleyes","sm_sigh","sm_sleep","sm_smile"],["sm_upset","sm_wink"]];e.addButton("vitabookemoticons",{type:"panelbutton",icon:"emoticons",panel:{autohide:true,html:r,onclick:function(t){var n=e.dom.getParent(t.target,"a");if(n){e.insertContent('<img src="'+n.getAttribute("data-mce-url")+'" />');this.hide()}}},tooltip:"VitaBook Emoticons"});if(i()!==false&&i()<9)return true;e.on("keydown",function(n){if(n.keyCode==13){return s(e,t)}});e.on("keyup",function(n){if(n.keyCode==32){return o(e,t)}})})